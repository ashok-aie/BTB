<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spell Bee Adventure üêù</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Baloo+2:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1c1c1c, #2d2d2d);
            color: #13a45e;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("/static/images/honeycomb.png");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.90;
            z-index: -1;
            filter: blur(0.6px) saturate(0.9);
        }

        header {
            text-align: center;
            padding: 36px 20px 10px 20px;
            position: relative;
        }

        header h1 {
            font-size: 2.4rem;
            margin: 0;
            color: #a0ea8f;
            text-shadow: 1px 1px 6px #0d0c0c;
        }

        header p {
            font-family: 'Baloo 2', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0 18px 0;
            color: #545505;
            animation: floatText 3.2s ease-in-out infinite;
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(239, 239, 239, 0.12);
        }

        @keyframes floatText {
            0% {
                transform: translateY(0);
                opacity: 0.95;
            }

            50% {
                transform: translateY(-4px);
                opacity: 1;
            }

            100% {
                transform: translateY(0);
                opacity: 0.95;
            }
        }

        .bee {
            position: absolute;
            width: 170px;
            z-index: 10;
            top: 8px;
            left: 8px;
            animation: fly 20s infinite linear;
        }

        @keyframes fly {
            0% {
                top: 8px;
                left: 8px;
                transform: rotate(0deg);
            }

            25% {
                top: 60px;
                left: 50%;
                transform: rotate(10deg);
            }

            50% {
                top: 110px;
                left: 80%;
                transform: rotate(10deg);
            }

            75% {
                top: 60px;
                left: 20%;
                transform: rotate(10deg);
            }

            100% {
                top: 8px;
                left: 8px;
                transform: rotate(0deg);
            }
        }

        .logout-btn {
            position: absolute;
            top: 18px;
            right: 20px;
            background: #01705e;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 12px 18px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            z-index: 20;
        }

        .logout-btn:hover {
            transform: scale(1.06);
        }

        main {
            max-width: 1300px;
            margin: 18px auto;
            padding: 0 16px;
        }

        .hero-row {
            display: flex;
            justify-content: center;
            margin-bottom: 18px;
        }

        .word-frame {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
            border-radius: 14px;
            padding: 18px 26px;
            text-align: center;
            border: 1px solid rgba(183, 181, 181, 0.06);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
            max-width: 820px;
            width: 100%;
            backdrop-filter: blur(6px);
        }

        .word-frame h2 {
            margin: 0 0 8px;
            font-size: 1.25rem;
            color: #f6c90e;
        }

        .word-frame p {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 900;
            color: #320303;
        }

        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .three-col {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 980px) {
            .three-col {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .three-col {
                grid-template-columns: 1fr;
            }

            .bee {
                display: none;
            }
        }

        .card {
            background: rgba(64, 62, 62, 0.95);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(6px);
        }

        .calendar {
            min-height: 260px;
            text-align: center;
        }

        .flatpickr-calendar {
            background: transparent !important;
            box-shadow: none !important;
        }

        .day-ring {
            border-radius: 50%;
            border: 2px solid transparent;
            padding: 3px;
            display: inline-block;
            transition: box-shadow 0.3s ease;
        }

        .day-ring.green {
            border-color: #00e676;
            box-shadow: 0 0 10px #00e67699;
            animation: glow 1.5s infinite alternate;
        }

        .day-ring.red {
            border-color: #ff5252;
            box-shadow: 0 0 10px #ff525299;
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            0% {
                box-shadow: 0 0 4px;
            }

            100% {
                box-shadow: 0 0 12px;
            }
        }

        .treasure-container {
            position: relative;
            text-align: center;
        }

        .treasure-container img {
            width: 240px;
            transition: transform 0.25s ease;
        }

        .treasure-container img:hover {
            transform: scale(1.17);
        }

        .reward-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .gems {
            display: flex;
            gap: 18px;
            align-items: center;
        }

        .gem {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .gem img {
            width: 75px;
            height: 75px;
        }

        .gem .count {
            font-weight: 800;
            color: #fff;
            font-size: 1rem;
        }

        .sparkles {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .sparkle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            opacity: 0;
            background: radial-gradient(circle at 30% 30%, #d270ef, #ffd700);
            transform: scale(0.6);
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.8));
            animation: sparkleAnim 1.8s linear infinite;
        }

        @keyframes sparkleAnim {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.6);
            }

            25% {
                opacity: 1;
                transform: translateY(-6px) scale(1);
            }

            60% {
                opacity: 0.6;
                transform: translateY(-12px) scale(0.9);
            }

            100% {
                opacity: 0;
                transform: translateY(-18px) scale(0.6);
            }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 50px 0 60px;
            flex-wrap: wrap;
        }

        button,
        select {
            background: #41d5df;
            color: #6a7803;
            border: none;
            border-radius: 10px;
            padding: 14px 22px;
            font-weight: 700;
            font-size: 1.5rem;
            cursor: pointer;
        }

        button:hover {
            background: #ffe066;
            transform: scale(1.08);
        }

        select {
            background: #333;
            color: #f6c90e;
            border: 1px solid #f6c90e;
            padding: 12px 20px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Welcome to Your Spell Bee Adventure, {{ user.username if user else 'Friend' }} üêù‚ú®</h1>
        <p>Every word you master makes your wings stronger!</p>
        <img src="/static/images/bee.png" class="bee" alt="Flying Bee">
        <button class="logout-btn" onclick="logout()">Logout üö™</button>
    </header>

    <main>
        <!-- Word of the Day -->
        <div class="hero-row">
            <div class="word-frame">
                <h2>üåü Word of the Day</h2>
                <p>{{ word_of_the_day or "frolic (adjective/verb/noun)- Means: full of fun (Dutch vroolijk, from Middle
                    Dutch vrolijc, from vro happy; akin to Old High German fr≈ç happy)" }}</p>
            </div>
        </div>

        <!-- Cards -->
        <div class="grid three-col" style="grid-template-columns:0.9fr 1.2fr 1fr;">
            <div class="card calendar">
                <h2>üî• Streak Calendar</h2>
                <div id="calendar"></div>
            </div>

            <div class="card">
                <h2>üìä Overall Progress</h2>
                <canvas id="overallChart" height="160"></canvas>
            </div>

            <div class="card treasure-container">
                <div class="reward-header">
                    <h2>üíé Rewards</h2>
                    <div class="gems">
                        <div class="gem"><img src="/static/images/diamond.png">
                            <div class="count"> {{ diamonds }}</div>
                        </div>
                        <div class="gem"><img src="/static/images/ruby.png">
                            <div class="count"> {{ rubies }}</div>
                        </div>
                    </div>
                </div>
                <img src="/static/images/treasure_chest.png">
                <div class="sparkles">
                    {% for i in range(1,9) %}<span class="sparkle d{{ i }}"></span>{% endfor %}
                </div>
            </div>
        </div>

        <!-- Last 10 Days -->
        <div class="grid three-col">
            <div class="card">
                <h2>üìÖ Last 10 Days Progress</h2><canvas id="last10DaysChart"></canvas>
            </div>
            <div class="card">
                <h2>üéØ Accuracy (Last 10 Days)</h2><canvas id="accuracyChart"></canvas>
            </div>
            <div class="card word-of-day-card">
                <h2>üìö Words of the Week</h2>
                <ul>{% for word in words_of_week %}<li>{{ word }}</li>{% endfor %}</ul>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <select id="gradeLevel">
                <option value="">All Grades</option>
                {% for grade in grade_levels %}
                <option value="{{ grade }}">{{ 'Grade ' ~ grade }}</option>
                {% endfor %}
            </select>
            <button onclick="goTo('spell_mastery')">Go to Spell Mastery üíéü™Ñ</button>
            <button onclick="goTo('vocab_mastery')">Go to Vocab Mastery üíñ</button>
            <button onclick="goTo('word_curing')">Go to Word Curing ü©∑</button>
        </div>
    </main>

    <script>
        // Logout
        function logout() {
            fetch("/logout", { method: "POST", credentials: "include" })
                .finally(() => window.location.href = "/login");
        }

        function goTo(page) {
            const grade = document.getElementById('gradeLevel').value;
            window.location.href = `/${page}?grade=${grade}`;
        }

        // Register DataLabels plugin
        Chart.register(ChartDataLabels);

        // Streak Calendar
        const streakDates = {{ streak_dates | tojson }};
        const failedDates = {{ failed_dates | tojson }};
        const calendarEl = document.getElementById("calendar");

        flatpickr(calendarEl, {
            inline: true,
            clickOpens: false,
            defaultDate: new Date(),
            monthSelectorType: "static",
            disableMobile: true,
            onDayCreate: function (dObj, dStr, fpInstance, dayElem) {
                if (!dayElem.dateObj) return;
                dayElem.classList.add('day-ring');
                const dateStr = dayElem.dateObj.toISOString().split("T")[0];
                if (streakDates.includes(dateStr)) dayElem.classList.add('green');
                else if (failedDates.includes(dateStr)) dayElem.classList.add('red');
            },
            onMonthChange: function (selectedDates, dateStr, instance) {
                instance.days.childNodes.forEach(day => {
                    if (!day.dateObj) return;
                    const dateStr = day.dateObj.toISOString().split("T")[0];
                    day.classList.remove('green', 'red');
                    if (streakDates.includes(dateStr)) day.classList.add('green');
                    else if (failedDates.includes(dateStr)) day.classList.add('red');
                });
            }
        });

        // Overall Progress Chart
        new Chart(document.getElementById("overallChart"), {
            type: "bar",
            data: {
                labels: ["Never Spelled", "Mastered", "Correct", "Misspelled"],
                align: 'center',
                datasets: [{
                    data: [
                        {{ never_spelled | int }},
                        {{ mastered | int }},
            {{ total_correct | int }},
            {{ total_wrong | int }}
                    ],
            align: 'center',
            backgroundColor: ["#90caf9", "#66bb6a", "#ffeb3b", "#f44336"],
            borderRadius: 6
                }]
            },
            options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: { anchor: 'end', align: 'bottom', color: '##000000', font: { weight: 'bold', size: 14 } }
            },
            scales: { y: { beginAtZero: true } }
        }
        });

        // Last 10 Days
        const days = {{ days | tojson }};
        const correctCounts = {{ correct_counts | tojson }};
        const wrongCounts = {{ wrong_counts | tojson }};
        const accuracyByDay = {{ accuracy_by_day | tojson }};

        new Chart(document.getElementById("last10DaysChart"), {
            type: "bar",
            data: {
                labels: days,
                datasets: [
                    { label: "Correct", data: correctCounts, backgroundColor: "#ffeb3b" },
                    { label: "Wrong", data: wrongCounts, backgroundColor: "#f44336" }
                ]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        new Chart(document.getElementById("accuracyChart"), {
            type: "line",
            data: {
                labels: days,
                datasets: [{
                    label: "Accuracy %",
                    data: accuracyByDay,
                    borderColor: "#4caf50",
                    fill: false,
                    tension: 0.3
                }]
            },
            options: {
                scales: { y: { min: 0, max: 100 } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    </script>
</body>

</html>